<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml"><meta charset="UTF-8"><link href="assets/css/source-ayu-light.css" rel="stylesheet" type="text/css"><script src="assets/js/highlight.js" type="text/javascript"></script><div id="package-header"><span class="caption"></span></div><pre id="src-content"><span class="ju-comment">{-
  A two-party exchange

  In this scenario there are ;Resource; types Dolphin, A and B.

  There are three participants, Alice, Bob and a Solver.

  Alice has:
  * 1 A and 2 B

  Bob has:
  * 1 Dolphin

  Alice is willing to exchange either 2 B or 1 A for 1 Dolphin.
  Bob is willing to exchange 1 A for 1 Dolphin.

  How to express this in Anoma using the Taiga execution model?

  Alice publishes a ;PartialTx; (1) to the gossip network that consumes two
  resources:

  1.1 An A ;Resource; with quantity 1

  1.2 A B ;Resource; with quantity 2

  and creates:

  1.3 A ;Resource; with quantity 1 containing a logic function which encodes
  her intent. i.e she wants to participate in a transaction that contains a
  partial transaction in which she receives either 1 Dolphin and 2 B or 1
  Dolphin and 1 A.

  Bob publishes a ;PartialTx; (2) to the gossip network that encodes his intent.
  It consumes:

  2.2 A Dolphin ;Resource; with quantity 1.

  and creates:

  2.1 An A ;Resource; with quantity 1


  The Solver finds both Alice&#39;s and Bob&#39;s partial transactions on the gossip
  network and publishes a new parital transaction (3) such that all the tial
  transactions logic are satisfied and the resources are balanced.

  The Solver&#39;s partial transaction consumes:

  3.1 Alice&#39;s logic ;Resource; created in 1.3.

  and creates:

  3.2 A Dolphin ;Resource; with quantity 1

  3.3 A B ;Resource; with quantity 2

  For a partial transaction to be valid, all of the logic functions associated
  with its resources must be valid. In our case, Alice&#39;s logic function is
  valid when applied to partial transaction 3.

  A transaction is formed from a collection of valid partial transaction that
  balance. i.e the quantities of created and consumed resources, for each
  resource type in the transaction must balance.

  This is true for the transaction containing the partial transactions 1,2,3 above.

  In particular:

  3.3 (create 2 B) balances with 1.2 (consume 2 B)
  3.2 (create 1 Dolphin) balances with 2.2 (consume 1 Dolphin)
  3.1 (consume Alice&#39;s intent) balances with 1.3 (create Alice&#39;s intent)
  2.1 (creates 1 A) balances with 1.1 (consume 1 A).
-}</span>

<span class="ju-keyword">module</span> <span id="0"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#0"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#0"><span class="ju-var">Apps<span class="ju-delimiter">.</span>TwoPartyExchange</span></a></span></a></span></span><span class="ju-delimiter">;</span>

<span class="ju-keyword">import</span> <span class="annot"><a href="Simulator-src.html#1"><span class="ju-var">Simulator</span></a></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span>
<span class="ju-keyword">import</span> <span class="annot"><a href="Simulator.Resource-src.html#2"><span class="ju-var">Simulator<span class="ju-delimiter">.</span>Resource</span></a></span> <span class="ju-keyword">open</span> <span class="ju-keyword">using</span> <span class="ju-delimiter">{</span><span class="annot"><a href="Simulator.Resource-src.html#723"><span class="ju-constructor">mkResource</span></a></span> <span class="ju-keyword">as</span> <span class="annot"><a href="Simulator.Resource-src.html#723"><span class="ju-constructor">mkResource&#39;</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span>
<span class="ju-keyword">import</span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1140"><span class="ju-var">Apps<span class="ju-delimiter">.</span>TwoPartyExchange<span class="ju-delimiter">.</span>Asset</span></a></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span>

<span class="ju-keyword">import</span> <span class="annot"><a href="Data.Map-src.html#787"><span class="ju-var">Data<span class="ju-delimiter">.</span>Map</span></a></span> <span class="ju-keyword">as</span> <span id="787"><span class="annot"><a href="Data.Map-src.html#787"><span class="annot"><a href="Data.Map-src.html#787"><span class="ju-var">Map</span></a></span></a></span></span><span class="ju-delimiter">;</span>
<span class="ju-keyword">open</span> <span class="annot"><a href="Data.Map-src.html#787"><span class="ju-var">Map</span></a></span> <span class="ju-keyword">using</span> <span class="ju-delimiter">{</span><span class="annot"><a href="Data.Map-src.html#1024"><span class="ju-inductive">Map</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span>

<span class="ju-keyword">import</span> <span class="annot"><a href="Simulator.Prelude-src.html#3"><span class="ju-var">Simulator<span class="ju-delimiter">.</span>Prelude</span></a></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span>

<span class="ju-judoc">---</span> <span class="ju-judoc">Definitions related to Alice&#39;s intent</span>
<span class="ju-keyword">module</span> <span id="1166"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1166"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1166"><span class="ju-var">AliceIntent</span></a></span></a></span></span><span class="ju-delimiter">;</span>
  <span id="1156"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1156"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1156"><span class="ju-function">
  logicFunction</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.PartialTx-src.html#774"><span class="ju-function">LogicFunction</span></a></span>
    <span class="ju-keyword">|</span> <span id="1161"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1161"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1161"><span class="ju-var">kind</span></a></span></a></span></span> <span id="1162"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1162"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1162"><span class="ju-var">tx</span></a></span></a></span></span> <span class="ju-keyword">:=</span>
      <span class="ju-keyword">let</span>
        <span id="1163"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="ju-function"><span class="ju-comment">{- check if the resource associated to this logic function is among the created (output) resources. Then check if alice&#39;s intent is satisfied. -}</span>
        createdRs</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Juvix.Builtin.V1.List-src.html#116"><span class="ju-inductive">List</span></a></span> <span class="annot"><a href="Simulator.Resource-src.html#722"><span class="ju-inductive">Resource</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a href="Simulator.PartialTx-src.html#773"><span class="ju-function">createdResources</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1162"><span class="ju-var">tx</span></a></span><span class="ju-delimiter">;</span>
        <span id="1164"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1164"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1164"><span class="ju-function">createdHashes</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Juvix.Builtin.V1.List-src.html#116"><span class="ju-inductive">List</span></a></span> <span class="annot"><a href="Simulator.Denomination-src.html#720"><span class="ju-inductive">LogicHash</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a href="Stdlib.Data.List.Base-src.html#268"><span class="ju-function">map</span></a></span> <span class="annot"><a href="Simulator.Resource-src.html#724"><span class="ju-function">Resource<span class="ju-delimiter">.</span>logicHash</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="ju-function">createdRs</span></a></span><span class="ju-delimiter">;</span>
      <span class="ju-keyword">in</span> <span class="annot"><a href="Simulator.Resource-src.html#743"><span class="ju-function">isCreated</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1161"><span class="ju-var">kind</span></a></span>
        <span class="annot"><a href="Stdlib.Data.Bool.Base-src.html#41"><span class="ju-function">||</span></a></span> <span class="annot"><a href="Simulator.Resource-src.html#735"><span class="ju-function"><span class="ju-delimiter">(</span>quantityOfDenom</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1143"><span class="ju-function">Dolphin<span class="ju-delimiter">.</span>denomination</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="ju-function">createdRs</span></a></span> <span class="annot"><a href="Stdlib.Trait.Eq-src.html#59"><span class="ju-function">==</span></a></span> <span class="ju-number">1</span>
          <span class="annot"><a href="Stdlib.Data.Bool.Base-src.html#42"><span class="ju-function">&amp;&amp;</span></a></span> <span class="annot"><a href="Simulator.Resource-src.html#735"><span class="ju-function">quantityOfDenom</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1148"><span class="ju-function">A<span class="ju-delimiter">.</span>denomination</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="ju-function">createdRs</span></a></span> <span class="annot"><a href="Stdlib.Trait.Eq-src.html#59"><span class="ju-function">==</span></a></span> <span class="ju-number">1</span><span class="ju-delimiter">)</span>
        <span class="annot"><a href="Stdlib.Data.Bool.Base-src.html#41"><span class="ju-function">||</span></a></span> <span class="annot"><a href="Simulator.Resource-src.html#735"><span class="ju-function">quantityOfDenom</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1143"><span class="ju-function">Dolphin<span class="ju-delimiter">.</span>denomination</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="ju-function">createdRs</span></a></span> <span class="annot"><a href="Stdlib.Trait.Eq-src.html#59"><span class="ju-function">==</span></a></span> <span class="ju-number">1</span>
        <span class="annot"><a href="Stdlib.Data.Bool.Base-src.html#42"><span class="ju-function">&amp;&amp;</span></a></span> <span class="annot"><a href="Simulator.Resource-src.html#735"><span class="ju-function">quantityOfDenom</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1153"><span class="ju-function">B<span class="ju-delimiter">.</span>denomination</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1163"><span class="ju-function">createdRs</span></a></span> <span class="annot"><a href="Stdlib.Trait.Eq-src.html#59"><span class="ju-function">==</span></a></span> <span class="ju-number">2</span><span class="ju-delimiter">;</span>

  <span class="ju-judoc">---</span> <span class="ju-judoc">This will be computed from the logic function</span>
  <span id="1157"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1157"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1157"><span class="ju-function">logicHash</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.Denomination-src.html#720"><span class="ju-inductive">LogicHash</span></a></span> <span class="ju-keyword">:=</span> <span class="ju-number">1</span><span class="ju-delimiter">;</span>
  <span id="1158"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1158"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1158"><span class="ju-function">
  staticData</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Data.ByteString-src.html#717"><span class="ju-function">ByteString</span></a></span> <span class="ju-keyword">:=</span> <span class="ju-keyword">[</span><span class="ju-number">3</span><span class="ju-keyword">]</span><span class="ju-delimiter">;</span>
  <span id="1159"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1159"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1159"><span class="ju-function">
  denomination</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.Denomination-src.html#721"><span class="ju-function">Denomination</span></a></span> <span class="ju-keyword">:=</span> <span class="ju-number">1</span> <span class="annot"><a href="Juvix.Builtin.V1.List-src.html#118"><span class="ju-constructor">::</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1158"><span class="ju-function">staticData</span></a></span><span class="ju-delimiter">;</span>
  <span id="1160"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1160"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1160"><span class="ju-function">
  mkResource</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1165"><span class="ju-var">n</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Stdlib.Data.Int.Base-src.html#590"><span class="ju-inductive">Int</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.Resource-src.html#722"><span class="ju-inductive">Resource</span></a></span> <span class="ju-keyword">:=</span>
    <span class="annot"><a href="Simulator.Resource-src.html#723"><span class="ju-constructor">mkResource&#39;</span></a></span>
      <span class="ju-delimiter">(</span>logicHash <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1157"><span class="ju-function">logicHash</span></a></span><span class="ju-delimiter">;</span>
      staticData <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1158"><span class="ju-function">staticData</span></a></span><span class="ju-delimiter">;</span>
      dynamicData <span class="ju-keyword">:=</span> <span class="annot"><a href="Juvix.Builtin.V1.List-src.html#117"><span class="ju-constructor">nil</span></a></span><span class="ju-delimiter">;</span>
      quantity <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1165"><span class="ju-var">n</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span>
<span class="ju-keyword">end</span><span class="ju-delimiter">;</span>

<span class="ju-judoc">---</span> <span class="ju-judoc">Definitions related to Alice</span>
<span class="ju-keyword">module</span> <span id="1168"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1168"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1168"><span class="ju-var">Alice</span></a></span></a></span></span><span class="ju-delimiter">;</span>
  <span id="1167"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1167"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1167"><span class="ju-function">partialTransaction</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.PartialTx-src.html#765"><span class="ju-inductive">PartialTx</span></a></span> <span class="ju-keyword">:=</span>
    <span class="annot"><a href="Simulator.PartialTx-src.html#766"><span class="ju-constructor">mkPartialTx</span></a></span>
      <span class="ju-delimiter">(</span>consumedPair <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1147"><span class="ju-function">A<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">1</span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1152"><span class="ju-function">B<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">2</span><span class="ju-delimiter">;</span>
      createdPair <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1160"><span class="ju-function">AliceIntent<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">1</span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Simulator.BuiltinResources-src.html#1097"><span class="ju-function">dummyResource</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span>
<span class="ju-keyword">end</span><span class="ju-delimiter">;</span>

<span class="ju-judoc">---</span> <span class="ju-judoc">Definitions related to Bob</span>
<span class="ju-keyword">module</span> <span id="1170"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1170"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1170"><span class="ju-var">Bob</span></a></span></a></span></span><span class="ju-delimiter">;</span>
  <span id="1169"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1169"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1169"><span class="ju-function">partialTransaction</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.PartialTx-src.html#765"><span class="ju-inductive">PartialTx</span></a></span> <span class="ju-keyword">:=</span>
    <span class="annot"><a href="Simulator.PartialTx-src.html#766"><span class="ju-constructor">mkPartialTx</span></a></span>
      <span class="ju-delimiter">(</span>consumedPair <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1142"><span class="ju-function">Dolphin<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">1</span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Simulator.BuiltinResources-src.html#1097"><span class="ju-function">dummyResource</span></a></span><span class="ju-delimiter">;</span>
      createdPair <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1147"><span class="ju-function">A<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">1</span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Simulator.BuiltinResources-src.html#1097"><span class="ju-function">dummyResource</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span>
<span class="ju-keyword">end</span><span class="ju-delimiter">;</span>

<span class="ju-judoc">---</span> <span class="ju-judoc">Definitions related to the Solver</span>
<span class="ju-keyword">module</span> <span id="1172"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1172"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1172"><span class="ju-var">Solver</span></a></span></a></span></span><span class="ju-delimiter">;</span>
  <span id="1171"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1171"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1171"><span class="ju-function">partialTransaction</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Simulator.PartialTx-src.html#765"><span class="ju-inductive">PartialTx</span></a></span> <span class="ju-keyword">:=</span>
    <span class="annot"><a href="Simulator.PartialTx-src.html#766"><span class="ju-constructor">mkPartialTx</span></a></span>
      <span class="ju-delimiter">(</span>consumedPair <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1160"><span class="ju-function">AliceIntent<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">1</span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Simulator.BuiltinResources-src.html#1097"><span class="ju-function">dummyResource</span></a></span><span class="ju-delimiter">;</span>
      createdPair <span class="ju-keyword">:=</span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1142"><span class="ju-function">Dolphin<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">1</span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange.Asset-src.html#1152"><span class="ju-function">B<span class="ju-delimiter">.</span>mkResource</span></a></span> <span class="ju-number">2</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span>
<span class="ju-keyword">end</span><span class="ju-delimiter">;</span>
<span id="1173"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1173"><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1173"><span class="ju-function">
logicFunctions</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a href="Data.Map-src.html#1024"><span class="ju-inductive">Map</span></a></span> <span class="annot"><a href="Simulator.Denomination-src.html#720"><span class="ju-inductive">LogicHash</span></a></span> <span class="annot"><a href="Simulator.PartialTx-src.html#774"><span class="ju-function">LogicFunction</span></a></span> <span class="ju-keyword">:=</span>
  <span class="annot"><a href="Simulator.BuiltinResources-src.html#1098"><span class="ju-function">mkLogicFunctionMap</span></a></span> <span class="ju-keyword">[</span><span class="annot"><a href="Apps.TwoPartyExchange-src.html#1157"><span class="ju-function">AliceIntent<span class="ju-delimiter">.</span>logicHash</span></a></span><span class="annot"><a href="Stdlib.Data.Product.Base-src.html#150"><span class="ju-constructor">,</span></a></span> <span class="annot"><a href="Apps.TwoPartyExchange-src.html#1156"><span class="ju-function">AliceIntent<span class="ju-delimiter">.</span>logicFunction</span></a></span><span class="ju-keyword">]</span><span class="ju-delimiter">;</span>
</pre><footer><pre>Powered by <a href="https://juvix.org">Juvix </a><a href="https://github.com/anoma/juvix/commit/c237f29">0.5.4-c237f29</a></pre></footer><span>Last modified on 2023-12-01 20:02 UTC</span></html>